import{r as e,R as s,j as t}from"./react-vendor-C8-TlGsU.js";import{u as a,s as r,S as i}from"./index-BaS3q1EV.js";import"./pdf-utils-DX6aKe5X.js";import"./vendor-D2WcXlqy.js";import"./supabase-DIRwJvxg.js";const l=({onNavigate:l,showToast:n,balance:c})=>{const{withLoading:o}=a(),[d,x]=e.useState([]),[m,p]=e.useState([]),[u,h]=e.useState(!0),[b,f]=e.useState(null),[g,j]=e.useState(!1);e.useEffect(()=>{N();const e=r.channel("shop-updates").on("postgres_changes",{event:"*",schema:"public",table:"products"},()=>w()).subscribe();return()=>{e.unsubscribe()}},[]);const N=async()=>{h(!0),await Promise.all([w(),v()]),h(!1)},w=async()=>{const{data:e}=await r.from("products").select("*").eq("status","active").order("price",{ascending:!0});e&&x(e)},v=async()=>{const{data:{user:e}}=await r.auth.getUser();if(!e)return;const{data:s}=await r.from("historico_compras").select("product_id").eq("user_id",e.id);s&&p(s.map(e=>e.product_id))},y=s.useCallback(e=>{m.includes(e.id)?n?.("Limite excedido, compre outro!","warning"):f(e)},[m,n]),C=s.useCallback(e=>{const[s,t]=e.toFixed(2).split(".");return{inteiro:s,centavos:t}},[]);return t.jsxs("div",{className:"bg-white min-h-screen text-[#0F1111] font-sans selection:bg-amber-100 pb-32",children:[t.jsx("main",{className:"max-w-md mx-auto bg-white pt-6",children:u?t.jsx("div",{className:"flex flex-col items-center justify-center py-40 gap-4",children:t.jsx(i,{size:"w-10 h-10",color:"text-[#00C853]"})}):t.jsx("div",{className:"flex flex-col gap-6 py-4",children:d.map(e=>{const{inteiro:s,centavos:a}=C(e.price),r=m.includes(e.id);return t.jsxs("div",{className:"flex gap-4 p-4 mx-4 items-start active:bg-gray-50 transition-colors bg-white rounded-2xl shadow-sm border border-gray-50",children:[t.jsxs("div",{className:"relative w-32 h-32 bg-gray-50 rounded-xl overflow-hidden shrink-0 flex items-center justify-center p-2",children:[t.jsx("img",{loading:"lazy",decoding:"async",src:e.image_url||"/placeholder_product.png",alt:e.name,className:"max-w-full max-h-full object-contain"}),t.jsx("div",{className:"absolute bottom-1.5 left-1.5 size-7 rounded-md flex items-center justify-center border shadow-sm "+("active"===e.status?"bg-green-50/90 border-green-100 text-[#00C853]":"bg-red-50/90 border-red-100 text-red-500"),children:t.jsx("span",{className:"material-symbols-outlined text-[18px]",children:"active"===e.status?"verified":"unpublished"})}),e.price<5e3&&t.jsx("div",{className:"absolute top-0 left-0 bg-[#CC0C39] text-white text-[9px] font-black px-2 py-0.5 rounded-br-lg uppercase tracking-wider",children:"TOP"})]}),t.jsxs("div",{className:"flex-1 min-w-0 flex flex-col",children:[t.jsx("h3",{className:"text-[16px] font-bold leading-tight text-[#0F1111] mb-1",children:e.name}),t.jsxs("div",{className:"flex flex-col gap-0.5 mb-2",children:[t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:"text-[12px] font-bold text-[#00C853]",children:"Renda:"}),t.jsxs("span",{className:"text-[12px] font-black text-black",children:["Kz ",e.daily_income?.toLocaleString()]})]}),t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:"text-[12px] font-bold text-[#00C853]",children:"Duração:"}),t.jsxs("span",{className:"text-[12px] font-black text-black",children:[e.duration_days," dias"]})]}),t.jsx("p",{className:"text-[11px] text-gray-400 line-clamp-1 mt-1 font-medium",children:e.description||"Produto oficial BP ENERGY."})]}),t.jsxs("div",{className:"flex items-center justify-between mt-auto",children:[t.jsxs("div",{className:"flex items-start",children:[t.jsx("span",{className:"text-[11px] font-bold mt-1 pr-0.5",children:"Kz"}),t.jsx("span",{className:"text-[20px] font-black leading-none",children:s}),t.jsx("span",{className:"text-[11px] font-bold mt-1",children:a})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"material-symbols-outlined text-[#00C853] text-[14px]",children:"verified"}),t.jsx("span",{className:"text-[10px] text-[#00C853] font-black uppercase",children:"Luanda"})]})]}),t.jsxs("div",{className:"mt-3",children:[t.jsx("button",{onClick:()=>y(e),disabled:r,className:"w-full h-[45px] rounded-xl text-[13px] font-black transition-all active:scale-[0.98] shadow-sm "+(r?"bg-gray-100 text-gray-400 cursor-not-allowed border border-gray-200":"bg-[#00C853] hover:brightness-105 text-white"),children:r?"Adquirido":"Comprar"}),r&&t.jsx("p",{className:"text-[9px] text-red-500 font-black mt-1 text-center uppercase tracking-tighter",children:"Limite Atingido"})]})]})]},e.id)})})}),b&&t.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/50 p-6",children:[t.jsx("div",{className:"absolute inset-0",onClick:()=>!g&&f(null)}),t.jsxs("div",{className:"relative w-full max-w-sm bg-white rounded-2xl p-6 border border-gray-100 animate-in zoom-in-95 duration-300",children:[t.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-2",children:"Confirmar Compra"}),t.jsxs("p",{className:"text-gray-600 text-[14px] leading-relaxed mb-6",children:["Deseja adquirir o item ",t.jsxs("span",{className:"font-bold",children:['"',b.name,'"']})," pelo valor de ",t.jsxs("span",{className:"font-bold text-black",children:["Kz ",b.price.toLocaleString()]}),"? Esta operação não pode ser desfeita."]}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("button",{disabled:g,onClick:async()=>{if(b){j(!0);try{const{data:{user:e}}=await r.auth.getUser();if(!e)throw new Error("Sessão expirada");if(c<b.price)throw new Error("Balance insuficiente");const{data:s,error:t}=await r.rpc("purchase_product",{p_product_id:b.id,p_user_id:e.id});if(t)throw t;if(!1===s?.success)throw new Error(s.message);f(null),n?.(s?.message||"Compra sucedida!","success"),p(e=>[...e,b.id]),setTimeout(()=>l("purchase-history"),1e3)}catch(e){n?.(e.message||"Falha na transação","error")}finally{j(!1)}}},className:"w-full h-[45px] bg-[#00C853] hover:bg-[#00C853] rounded-full font-bold text-white text-[14px] transition-all active:scale-95 flex items-center justify-center font-black",children:g?t.jsx(i,{size:"w-5 h-5",color:"text-black"}):"Confirmar"}),t.jsx("button",{disabled:g,onClick:()=>f(null),className:"w-full h-[45px] bg-white hover:bg-gray-50 border border-gray-300 rounded-full font-bold text-[14px] transition-colors",children:"Cancelar"})]}),t.jsx("p",{className:"text-[10px] text-center text-gray-400 mt-4 uppercase tracking-widest font-bold",children:"Compra Segura BP"})]})]})]})};export{l as default};
